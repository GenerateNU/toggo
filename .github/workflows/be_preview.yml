name: Backend Deployment Preview

on:
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/be_*.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Deploy backend
        id: deploy
        uses: digitalocean/app_action/deploy@v2
        with:
          deploy_pr_preview: "true"
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          app_id: ${{ secrets.DIGITALOCEAN_APP_ID }}
      - uses: actions/github-script@v7
        with:
          script: |
            const deploy = steps.deploy.outputs
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ The backend was successfully deployed at ${JSON.parse(deploy.app).live_url}.`
            })
      - uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const deploy = steps.deploy.outputs
            const build_logs = deploy.build_logs
            const deploy_logs = deploy.deploy_logs
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `The backend failed to deploy. Logs:
              <details><summary>Build logs</summary>\`\`\`
              ${build_logs}\`\`\`</details>
              <details><summary>Deploy logs</summary>\`\`\`
              ${deploy_logs}\`\`\`</details>`
            })